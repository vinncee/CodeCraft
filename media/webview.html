<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}} 'unsafe-inline'; script-src 'nonce-{{nonce}}'; img-src {{cspSource}} https:;">
  <link href="{{styleUri}}" rel="stylesheet">
  <link href="{{codiconsUri}}" rel="stylesheet">
  <title>CodeCraft AI Mentor</title>
</head>
<body>
  <div class="app-container">
    <!-- Main content area -->
    <main class="main-content">
      <div class="tabs">
        <button class="tab-button active" data-tab="chat">
          <i class="codicon codicon-comment"></i> Chat
        </button>
        <button class="tab-button" data-tab="journal">
          <i class="codicon codicon-book"></i> Learning Journal
        </button>
      </div>

      <!-- Chat tab content -->
      <div class="tab-content active" id="chat-tab">
        <div class="chat-container">
          <div id="api-key-warning" class="api-key-warning hidden">
            <p><i class="codicon codicon-warning"></i> Hugging Face API token not set. Please set your API token to use the AI features.</p>
            <button id="set-api-key-btn">Set API Token</button>
          </div>

          <div class="notification-banner success hidden" id="notification-banner">
            <i class="codicon codicon-info"></i>
            <span id="notification-message">This is a notification message</span>
            <button class="icon-button" id="close-notification-btn">
              <i class="codicon codicon-close"></i>
            </button>
          </div>
          
          <div class="messages">
            <div class="message ai">
              <div class="message-content">
                <p>Hello! I'm your AI coding mentor powered by Hugging Face. I'm here to help you learn programming concepts through guided discovery rather than direct answers.</p>
                <p>What would you like to explore today?</p>
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
          
          <div class="error-explainer hidden">
            <button id="explain-error-btn">
              <i class="codicon codicon-debug"></i>
              Explain This Error
            </button>
          </div>

          <div class="settings-row">
            <div class="mode-toggle">
              <span>Response Mode:</span>
              <div class="toggle-container">
                <button class="toggle-button" data-mode="text">
                  <i class="codicon codicon-text-size"></i> Text Guide
                </button>
                <button class="toggle-button" data-mode="visual">
                  <i class="codicon codicon-symbol-color"></i> Visual Metaphor
                </button>
              </div>
            </div>

            <div class="theme-selector">
              <span>Theme:</span>
              <div class="dropdown">
                <button id="theme-dropdown-btn" class="dropdown-button">
                  <span id="current-theme">Default</span>
                  <i class="codicon codicon-chevron-down"></i>
                </button>
                <div class="dropdown-content">
                  <div class="theme-option" data-theme="default">
                    <div class="theme-preview default-theme"></div>
                    <span>Default</span>
                  </div>
                  <div class="theme-option" data-theme="ocean">
                    <div class="theme-preview ocean-theme"></div>
                    <span>Ocean</span>
                  </div>
                  <div class="theme-option" data-theme="forest">
                    <div class="theme-preview forest-theme"></div>
                    <span>Forest</span>
                  </div>
                  <div class="theme-option" data-theme="sunset">
                    <div class="theme-preview sunset-theme"></div>
                    <span>Sunset</span>
                  </div>
                  <div class="theme-option" data-theme="midnight">
                    <div class="theme-preview midnight-theme"></div>
                    <span>Midnight</span>
                  </div>
                  <div class="theme-option" data-theme="cyberpunk">
                    <div class="theme-preview cyberpunk-theme"></div>
                    <span>Cyberpunk</span>
                  </div>
                  <div class="theme-option" data-theme="monochrome">
                    <div class="theme-preview monochrome-theme"></div>
                    <span>Monochrome</span>
                  </div>
                  <div class="theme-option" data-theme="pastel">
                    <div class="theme-preview pastel-theme"></div>
                    <span>Pastel</span>
                  </div>
                  <div class="theme-option" data-theme="autumn">
                    <div class="theme-preview autumn-theme"></div>
                    <span>Autumn</span>
                  </div>
                  <div class="theme-option" data-theme="neon">
                    <div class="theme-preview neon-theme"></div>
                    <span>Neon</span>
                  </div>
                  <div class="theme-option" data-theme="arctic">
                    <div class="theme-preview arctic-theme"></div>
                    <span>Arctic</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="socratic-level">
            <span>Socratic Strictness:</span>
            <div class="toggle-container">
              <button class="socratic-button" data-level="strict">
                <i class="codicon codicon-question"></i> Strict
              </button>
              <button class="socratic-button" data-level="balanced">
                <i class="codicon codicon-combine"></i> Balanced
              </button>
              <button class="socratic-button" data-level="flexible">
                <i class="codicon codicon-lightbulb"></i> Flexible
              </button>
            </div>
          </div>

          <div class="code-snippets-panel hidden" id="code-snippets-panel">
            <div class="snippets-header">
              <h3>Code Snippets Library</h3>
              <button id="close-snippets-btn" class="icon-button">
                <i class="codicon codicon-close"></i>
              </button>
            </div>
            <div class="snippets-search">
              <input type="text" placeholder="Search snippets..." id="snippets-search-input">
              <button class="icon-button" id="snippets-search-btn">
                <i class="codicon codicon-search"></i>
              </button>
            </div>
            <div class="snippets-list" id="snippets-list">
              <!-- Snippets will be populated dynamically -->
              <div class="snippet-item">
                <div class="snippet-header">
                  <span class="snippet-title">Array Sorting</span>
                  <span class="snippet-language">JavaScript</span>
                </div>
                <pre class="snippet-code"><code>// Sort array of numbers
const numbers = [3, 1, 4, 1, 5, 9];
numbers.sort((a, b) => a - b);</code></pre>
                <div class="snippet-actions">
                  <button class="snippet-action-btn" title="Copy to clipboard">
                    <i class="codicon codicon-copy"></i>
                  </button>
                  <button class="snippet-action-btn" title="Insert into message">
                    <i class="codicon codicon-arrow-down"></i>
                  </button>
                </div>
              </div>
              <div class="snippet-item">
                <div class="snippet-header">
                  <span class="snippet-title">Async/Await Example</span>
                  <span class="snippet-language">JavaScript</span>
                </div>
                <pre class="snippet-code"><code>async function fetchData() {
  try {
    const response = await fetch('https://api.example.com/data');
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching data:', error);
  }
}</code></pre>
                <div class="snippet-actions">
                  <button class="snippet-action-btn" title="Copy to clipboard">
                    <i class="codicon codicon-copy"></i>
                  </button>
                  <button class="snippet-action-btn" title="Insert into message">
                    <i class="codicon codicon-arrow-down"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="snippets-footer">
              <button id="add-snippet-btn" class="secondary-button">
                <i class="codicon codicon-add"></i> Add New Snippet
              </button>
            </div>
          </div>

          <!-- Make sure the icon is properly defined in the button -->
          <div class="input-container">
            <div class="input-actions">
              <button id="show-snippets-btn" class="icon-button" title="Code Snippets">
                <i class="codicon codicon-library"></i>
              </button>
              <button id="show-keyboard-shortcuts-btn" class="icon-button" title="Keyboard Shortcuts">
                <i class="codicon codicon-keyboard"></i>
              </button>
            </div>
            <textarea id="message-input" placeholder="Ask me anything about coding..."></textarea>
            <button id="send-button" title="Send message">
              <span class="arrow-up">â†‘</span>
            </button>
          </div>
          
          <div class="exp-container">
            <div class="exp-label">
              <span>Experience</span>
              <span id="exp-value">0 XP</span>
            </div>
            <div class="exp-bar">
              <div id="exp-fill" class="exp-fill" style="width: 0%"></div>
            </div>
            <div class="exp-level">
              <span>Level <span id="current-level">1</span></span>
              <span id="level-progress">0/100</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Learning Journal tab content -->
      <div class="tab-content" id="journal-tab">
        <div class="journal-container">
          <div class="journal-header">
            <h2>Learning Analytics</h2>
            <div class="time-filter">
              <select id="time-filter">
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="all">All Time</option>
              </select>
            </div>
          </div>

          <div class="quick-actions">
            <button class="quick-action-btn" id="export-data-btn">
              <i class="codicon codicon-cloud-download"></i> Export Learning Data
            </button>
            <button class="quick-action-btn" id="import-data-btn">
              <i class="codicon codicon-cloud-upload"></i> Import Learning Data
            </button>
            <button class="quick-action-btn" id="clear-history-btn">
              <i class="codicon codicon-clear-all"></i> Clear History
            </button>
            <button class="quick-action-btn" id="print-report-btn">
              <i class="codicon codicon-file-pdf"></i> Generate Report
            </button>
          </div>

          <div class="journal-sections">
            <div class="journal-main">
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-title">Errors Resolved</div>
                  <div class="metric-value" id="errors-resolved">0</div>
                </div>
                <div class="metric-card">
                  <div class="metric-title">Concepts Learned</div>
                  <div class="metric-value" id="concepts-learned">0</div>
                </div>
                <div class="metric-card">
                  <div class="metric-title">Practice Time</div>
                  <div class="metric-value" id="practice-time">0h</div>
                </div>
                <div class="metric-card">
                  <div class="metric-title">Code Quality</div>
                  <div class="metric-value" id="code-quality">N/A</div>
                </div>
              </div>

              <div class="learning-progress-chart">
                <h3>Learning Progress Over Time</h3>
                <div class="chart-container">
                  <canvas id="learning-progress-chart"></canvas>
                </div>
              </div>

              <div class="timeline">
                <h3>Recent Activity</h3>
                <div id="timeline-items">
                  <!-- Timeline items will be populated dynamically -->
                </div>
              </div>

              <div class="study-plan">
                <h3>Recommended Study Plan</h3>
                <div class="checklist">
                  <div class="checklist-item">
                    <input type="checkbox" id="item1">
                    <label for="item1">Review Promise chaining vs async/await</label>
                  </div>
                  <div class="checklist-item">
                    <input type="checkbox" id="item2">
                    <label for="item2">Practice error handling in asynchronous code</label>
                  </div>
                  <div class="checklist-item">
                    <input type="checkbox" id="item3" checked>
                    <label for="item3">Complete the loop optimization exercise</label>
                  </div>
                  <div class="checklist-item">
                    <input type="checkbox" id="item4">
                    <label for="item4">Learn about React useEffect cleanup functions</label>
                  </div>
                  <div class="checklist-item">
                    <input type="checkbox" id="item5">
                    <label for="item5">Implement a basic unit test for your current project</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="journal-sidebar">
              <div class="learning-journey-section">
                <h3>Learning Analytics</h3>
                
                <div class="stat-card">
                  <div class="stat-header">
                    <h4>Skill Breakdown</h4>
                    <span class="stat-info" title="Your relative proficiency in different coding areas">
                      <i class="codicon codicon-info"></i>
                    </span>
                  </div>
                  <div class="skill-bars">
                    <div class="skill-item">
                      <div class="skill-info">
                        <span>JavaScript</span>
                        <span id="js-skill-value">65%</span>
                      </div>
                      <div class="skill-progress">
                        <div class="skill-progress-bar" id="js-skill-bar" style="width: 65%"></div>
                      </div>
                    </div>
                    <div class="skill-item">
                      <div class="skill-info">
                        <span>Problem Solving</span>
                        <span id="problem-skill-value">78%</span>
                      </div>
                      <div class="skill-progress">
                        <div class="skill-progress-bar" id="problem-skill-bar" style="width: 78%"></div>
                      </div>
                    </div>
                    <div class="skill-item">
                      <div class="skill-info">
                        <span>Debugging</span>
                        <span id="debug-skill-value">42%</span>
                      </div>
                      <div class="skill-progress">
                        <div class="skill-progress-bar" id="debug-skill-bar" style="width: 42%"></div>
                      </div>
                    </div>
                    <div class="skill-item">
                      <div class="skill-info">
                        <span>Code Organization</span>
                        <span id="org-skill-value">55%</span>
                      </div>
                      <div class="skill-progress">
                        <div class="skill-progress-bar" id="org-skill-bar" style="width: 55%"></div>
                      </div>
                    </div>
                  </div>
                </div>
                  
                <div class="stat-card">
                  <div class="stat-header">
                    <h4>Learning Streak</h4>
                    <span class="stat-info" title="Your consecutive days of learning">
                      <i class="codicon codicon-info"></i>
                    </span>
                  </div>
                  <div class="streak-calendar">
                    <div class="streak-number">
                      <span class="streak-days" id="streak-count">5</span>
                      <span class="streak-label">day streak</span>
                    </div>
                    <div class="streak-grid" id="streak-grid">
                      <div class="streak-day active" data-date="2025-04-01"></div>
                      <div class="streak-day active" data-date="2025-04-02"></div>
                      <div class="streak-day active" data-date="2025-04-03"></div>
                      <div class="streak-day active" data-date="2025-04-04"></div>
                      <div class="streak-day active" data-date="2025-04-05"></div>
                      <div class="streak-day" data-date="2025-04-06"></div>
                      <div class="streak-day" data-date="2025-04-07"></div>
                    </div>
                  </div>
                </div>
                  
                <div class="stat-card">
                  <div class="stat-header">
                    <h4>Error Resolution Rate</h4>
                    <span class="stat-info" title="How quickly you resolve coding errors">
                      <i class="codicon codicon-info"></i>
                    </span>
                  </div>
                  <div class="resolution-stats">
                    <div class="resolution-chart">
                      <div class="chart-donut">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                          <path class="circle-bg" d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831" />
                          <path class="circle" id="resolution-circle" stroke-dasharray="75, 100" d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831" />
                          <text x="18" y="20.35" class="percentage" id="resolution-percentage">75%</text>
                        </svg>
                      </div>
                    </div>
                    <div class="resolution-details">
                      <div class="resolution-stat">
                        <span class="stat-label">Avg. Time:</span>
                        <span class="stat-value" id="avg-resolution-time">14 min</span>
                      </div>
                      <div class="resolution-stat">
                        <span class="stat-label">Errors Fixed:</span>
                        <span class="stat-value" id="errors-fixed-count">23</span>
                      </div>
                    </div>
                  </div>
                </div>
                  
                <div class="stat-card">
                  <div class="stat-header">
                    <h4>Most Active Times</h4>
                    <span class="stat-info" title="When you are most active coding">
                      <i class="codicon codicon-info"></i>
                    </span>
                  </div>
                  <div class="active-times">
                    <div class="time-bar-chart" id="time-bar-chart">
                      <div class="time-bar" style="height: 30%;" data-time="9AM"></div>
                      <div class="time-bar" style="height: 40%;" data-time="12PM"></div>
                      <div class="time-bar" style="height: 60%;" data-time="3PM"></div>
                      <div class="time-bar" style="height: 100%;" data-time="6PM"></div>
                      <div class="time-bar" style="height: 80%;" data-time="9PM"></div>
                      <div class="time-bar" style="height: 35%;" data-time="12AM"></div>
                    </div>
                    <div class="time-labels">
                      <span>9AM</span>
                      <span>12PM</span>
                      <span>3PM</span>
                      <span>6PM</span>
                      <span>9PM</span>
                      <span>12AM</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="weekly-goals-section">
                <div class="progress-header">
                  <h3>Weekly Goals</h3>
                  <button id="reset-goals-btn" class="reset-goals-btn" title="Reset weekly goals">
                    <i class="codicon codicon-refresh"></i>
                  </button>
                </div>
                <div id="weekly-goals">
                  <!-- Weekly goals will be populated dynamically -->
                  <div class="goal-item" data-goal-id="learning">
                    <div class="progress-label">
                      <span>Learning Progress</span>
                      <span class="goal-progress">0/100</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 0%"></div>
                    </div>
                  </div>
                  <div class="goal-item" data-goal-id="challenges">
                    <div class="progress-label">
                      <span>Challenges Completed</span>
                      <span class="goal-progress">0/5</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="goal-actions">
                      <button class="goal-increment-btn" data-goal-id="challenges">
                        <i class="codicon codicon-add"></i> Complete Challenge
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="keyboard-shortcuts-modal hidden" id="keyboard-shortcuts-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Keyboard Shortcuts</h3>
        <button id="close-shortcuts-modal-btn" class="icon-button">
          <i class="codicon codicon-close"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="shortcuts-list">
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>Enter</kbd></span>
            <span class="shortcut-description">Send message</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>L</kbd></span>
            <span class="shortcut-description">Clear conversation</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>S</kbd></span>
            <span class="shortcut-description">Save conversation</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>B</kbd></span>
            <span class="shortcut-description">Toggle code snippets panel</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>1</kbd></span>
            <span class="shortcut-description">Switch to Chat tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>2</kbd></span>
            <span class="shortcut-description">Switch to Learning Journal tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>/</kbd></span>
            <span class="shortcut-description">Show keyboard shortcuts</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script nonce="{{nonce}}">
    (function() {
      const vscode = acquireVsCodeApi();
      
      // DOM Elements
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const messagesContainer = document.querySelector('.messages');
      const explainErrorBtn = document.getElementById('explain-error-btn');
      const errorExplainer = document.querySelector('.error-explainer');
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      const toggleButtons = document.querySelectorAll('.toggle-button');
      const socraticButtons = document.querySelectorAll('.socratic-button');
      const apiKeyWarning = document.getElementById('api-key-warning');
      const setApiKeyBtn = document.getElementById('set-api-key-btn');
      const themeDropdownBtn = document.getElementById('theme-dropdown-btn');
      const themeOptions = document.querySelectorAll('.theme-option');
      const currentThemeText = document.getElementById('current-theme');
      const resetGoalsBtn = document.getElementById('reset-goals-btn');
      const goalIncrementBtns = document.querySelectorAll('.goal-increment-btn');
      const weeklyGoalsContainer = document.getElementById('weekly-goals');
      const timelineItems = document.getElementById('timeline-items');
      const timeFilter = document.getElementById('time-filter');
      const errorsResolved = document.getElementById('errors-resolved');
      const conceptsLearned = document.getElementById('concepts-learned');
      const practiceTime = document.getElementById('practice-time');
      const codeQuality = document.getElementById('code-quality');
      const showSnippetsBtn = document.getElementById('show-snippets-btn');
      const closeSnippetsBtn = document.getElementById('close-snippets-btn');
      const codeSnippetsPanel = document.getElementById('code-snippets-panel');
      const showKeyboardShortcutsBtn = document.getElementById('show-keyboard-shortcuts-btn');
      const keyboardShortcutsModal = document.getElementById('keyboard-shortcuts-modal');
      const closeShortcutsModalBtn = document.getElementById('close-shortcuts-modal-btn');
      const notificationBanner = document.getElementById('notification-banner');
      const notificationMessage = document.getElementById('notification-message');
      const closeNotificationBtn = document.getElementById('close-notification-btn');
      
      // Learning analytics elements
      const jsSkillValue = document.getElementById('js-skill-value');
      const jsSkillBar = document.getElementById('js-skill-bar');
      const problemSkillValue = document.getElementById('problem-skill-value');
      const problemSkillBar = document.getElementById('problem-skill-bar');
      const debugSkillValue = document.getElementById('debug-skill-value');
      const debugSkillBar = document.getElementById('debug-skill-bar');
      const orgSkillValue = document.getElementById('org-skill-value');
      const orgSkillBar = document.getElementById('org-skill-bar');
      const streakCount = document.getElementById('streak-count');
      const streakGrid = document.getElementById('streak-grid');
      const resolutionCircle = document.getElementById('resolution-circle');
      const resolutionPercentage = document.getElementById('resolution-percentage');
      const avgResolutionTime = document.getElementById('avg-resolution-time');
      const errorsFixedCount = document.getElementById('errors-fixed-count');
      const timeBarChart = document.getElementById('time-bar-chart');
      
      // Initialize with stored state
      const state = vscode.getState() || { 
        messages: [],
        activeTab: 'chat',
        responseMode: 'text',
        socraticLevel: 'balanced',
        exp: 0,
        level: 1,
        expToNextLevel: 100,
        theme: 'default',
        weeklyGoals: [],
        activities: [],
        learningStats: {
          skills: {
            javascript: 65,
            problemSolving: 78,
            debugging: 42,
            codeOrganization: 55
          },
          streak: {
            currentStreak: 5,
            lastActive: new Date().toISOString(),
            activeDays: ["2025-04-01", "2025-04-02", "2025-04-03", "2025-04-04", "2025-04-05"]
          },
          errorResolution: {
            rate: 75,
            avgTime: 14,
            totalFixed: 23
          },
          activeTimes: {
            "9AM": 30,
            "12PM": 40,
            "3PM": 60,
            "6PM": 100,
            "9PM": 80,
            "12AM": 35
          },
          progressHistory: [
            { date: "2025-03-01", value: 10 },
            { date: "2025-03-08", value: 25 },
            { date: "2025-03-15", value: 40 },
            { date: "2025-03-22", value: 55 },
            { date: "2025-03-29", value: 65 },
            { date: "2025-04-05", value: 80 }
          ]
        }
      };
      
      // Apply saved theme on load
      if (state.theme) {
        applyTheme(state.theme);
      }
      
      // Check API key status on load
      vscode.postMessage({
        command: 'checkApiKey'
      });
      
      // Initialize learning analytics
      initializeLearningAnalytics();
      
      // Handle sending messages
      function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        
        // Add message to UI
        addMessageToUI(text, true);
        
        // Send to extension
        vscode.postMessage({
          command: 'sendMessage',
          text: text
        });
        
        // Clear input
        messageInput.value = '';

        // Update experience
        updateExperience();
        
        // Update learning stats
        updateLearningStats('messaging');
      }
      
      // Add message to UI
      function addMessageToUI(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'message user' : 'message ai';
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Process markdown-like syntax for code blocks
        let processedText = text;
        if (!isUser) {
          // Replace \`\`\`code\`\`\` with styled code blocks
          processedText = text.replace(/\`\`\`([\s\S]*?)\`\`\`/g, '<pre><code>$1</code></pre>');
          
          // Replace `inline code` with styled inline code
          processedText = processedText.replace(/`([^`]+)`/g, '<code>$1</code>');
        }
        
        messageDiv.innerHTML = `
          <div class="message-content">
            ${isUser ? `<p>${text}</p>` : processedText}
          </div>
          <div class="message-time">${time}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Update state
        state.messages.push({
          text,
          isUser,
          timestamp: new Date().toISOString()
        });
        vscode.setState(state);
      }
      
      // Update experience
      function updateExperience() {
        // Only add exp for user messages
        const expGain = 10;
        state.exp += expGain;
        
        // Get current XP requirement for this level
        const currentLevelXP = Math.floor(100 * Math.pow(1.5, state.level - 1));
        
        // Check if leveled up
        let leveledUp = false;
        while (state.exp >= state.expToNextLevel) {
          state.exp -= state.expToNextLevel;
          state.level++;
          leveledUp = true;
          // Calculate new XP requirement for next level
          state.expToNextLevel = Math.floor(100 * Math.pow(1.5, state.level - 1));
        }
        
        // Show level up notification if leveled up
        if (leveledUp) {
          const levelUpDiv = document.createElement('div');
          levelUpDiv.className = 'level-up-notification';
          levelUpDiv.textContent = `Level Up! You're now level ${state.level}`;
          document.body.appendChild(levelUpDiv);
          
          // Remove notification after animation
          setTimeout(() => {
            levelUpDiv.classList.add('fade-out');
            setTimeout(() => {
              document.body.removeChild(levelUpDiv);
            }, 500);
          }, 3000);
        }
        
        // Calculate progress percentage
        const progressPercent = (state.exp / state.expToNextLevel) * 100;
        
        // Update UI
        document.getElementById('exp-value').textContent = `${state.exp} XP`;
        document.getElementById('exp-fill').style.width = `${progressPercent}%`;
        document.getElementById('current-level').textContent = state.level;
        document.getElementById('level-progress').textContent = `${state.exp}/${state.expToNextLevel}`;
        
        // Save state
        vscode.setState(state);

        // Send experience update to extension for persistent storage
        vscode.postMessage({
          command: 'updateExperience',
          exp: state.exp,
          level: state.level
        });
        
        // Update learning progress goal
        updateGoalProgress('learning', 1);
      }

      // Apply theme
      function applyTheme(themeName) {
        // Remove all theme classes
        document.body.classList.remove('theme-default', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-midnight', 'theme-cyberpunk', 'theme-monochrome', 'theme-pastel', 'theme-autumn', 'theme-neon', 'theme-arctic');
        
        // Add selected theme class
        document.body.classList.add(`theme-${themeName}`);
        
        // Update current theme text
        currentThemeText.textContent = themeName.charAt(0).toUpperCase() + themeName.slice(1);
        
        // Save theme in state
        state.theme = themeName;
        vscode.setState(state);
      }
      
      // Update weekly goals UI
      function updateWeeklyGoalsUI(goals) {
        state.weeklyGoals = goals;
        vscode.setState(state);
        
        goals.forEach(goal => {
          const goalElement = document.querySelector(`.goal-item[data-goal-id="${goal.id}"]`);
          if (goalElement) {
            const progressLabel = goalElement.querySelector('.goal-progress');
            const progressFill = goalElement.querySelector('.progress-fill');
            
            if (progressLabel) {
              progressLabel.textContent = `${goal.current}/${goal.target}`;
            }
            
            if (progressFill) {
              const percentage = Math.min((goal.current / goal.target) * 100, 100);
              progressFill.style.width = `${percentage}%`;
              
              // Add completed class if goal is met
              if (goal.current >= goal.target) {
                goalElement.classList.add('goal-completed');
              } else {
                goalElement.classList.remove('goal-completed');
              }
            }
          }
        });
      }
      
      // Update goal progress
      function updateGoalProgress(goalId, increment) {
        vscode.postMessage({
          command: 'updateGoalProgress',
          goalId: goalId,
          increment: increment
        });
      }
      
      // Reset weekly goals
      function resetWeeklyGoals() {
        vscode.postMessage({
          command: 'resetWeeklyGoals'
        });
      }
      
      // Function to display activities
      function displayActivities(activities, filter = 'all') {
        timelineItems.innerHTML = '';
        
        // Filter activities by time range
        let filteredActivities = activities;
        if (filter === 'week') {
          filteredActivities = activities.filter(activity => {
            const activityDate = new Date(activity.date);
            const now = new Date();
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            return activityDate >= startOfWeek;
          });
        } else if (filter === 'month') {
          filteredActivities = activities.filter(activity => {
            const activityDate = new Date(activity.date);
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return activityDate >= startOfMonth;
          });
        }
        
        // Add each activity to the timeline
        filteredActivities.forEach(activity => {
          const activityDate = new Date(activity.date).toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          
          const timelineItem = document.createElement('div');
          timelineItem.className = 'timeline-item';
          timelineItem.innerHTML = `
            <div class="timeline-date">${activityDate}</div>
            <div class="timeline-content">
              <div class="timeline-title">${activity.title}</div>
              <div class="timeline-description">${activity.description}</div>
            </div>
          `;
          timelineItems.appendChild(timelineItem);
        });
        
        // Update metrics
        updateMetrics(activities);
      }
      
      // Function to update metrics
      function updateMetrics(activities) {
        let errors = 0;
        let concepts = 0;
        
        activities.forEach(activity => {
          if (activity.title === 'Error Explained') {
            errors++;
          } else if (activity.title === 'Sent Message') {
            concepts++;
          }
        });
        
        errorsResolved.textContent = errors.toString();
        conceptsLearned.textContent = concepts.toString();
        
        // Calculate practice time based on activities
        const totalMinutes = activities.length * 5; // Assume 5 minutes per activity
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        practiceTime.textContent = `${hours}h ${minutes}m`;
        
        // Calculate code quality score based on error resolution rate
        const qualityScore = state.learningStats.errorResolution.rate;
        codeQuality.textContent = `${qualityScore}%`;
      }
      
      // Initialize learning analytics
      function initializeLearningAnalytics() {
        // Update skill bars
        updateSkillBars();
        
        // Update streak calendar
        updateStreakCalendar();
        
        // Update error resolution stats
        updateErrorResolutionStats();
        
        // Update active times chart
        updateActiveTimesChart();
        
        // Initialize learning progress chart
        initializeLearningProgressChart();
      }
      
      // Update skill bars
      function updateSkillBars() {
        const skills = state.learningStats.skills;
        
        jsSkillValue.textContent = `${skills.javascript}%`;
        jsSkillBar.style.width = `${skills.javascript}%`;
        
        problemSkillValue.textContent = `${skills.problemSolving}%`;
        problemSkillBar.style.width = `${skills.problemSolving}%`;
        
        debugSkillValue.textContent = `${skills.debugging}%`;
        debugSkillBar.style.width = `${skills.debugging}%`;
        
        orgSkillValue.textContent = `${skills.codeOrganization}%`;
        orgSkillBar.style.width = `${skills.codeOrganization}%`;
      }
      
      // Update streak calendar
      function updateStreakCalendar() {
        const streak = state.learningStats.streak;
        
        streakCount.textContent = streak.currentStreak;
        
        // Clear existing streak days
        streakGrid.innerHTML = '';
        
        // Get the last 7 days
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateString = date.toISOString().split('T')[0];
          
          const dayElement = document.createElement('div');
          dayElement.className = 'streak-day';
          dayElement.setAttribute('data-date', dateString);
          
          if (streak.activeDays.includes(dateString)) {
            dayElement.classList.add('active');
          }
          
          streakGrid.appendChild(dayElement);
        }
      }
      
      // Update error resolution stats
      function updateErrorResolutionStats() {
        const errorStats = state.learningStats.errorResolution;
        
        resolutionCircle.setAttribute('stroke-dasharray', `${errorStats.rate}, 100`);
        resolutionPercentage.textContent = `${errorStats.rate}%`;
        avgResolutionTime.textContent = `${errorStats.avgTime} min`;
        errorsFixedCount.textContent = errorStats.totalFixed;
      }
      
      // Update active times chart
      function updateActiveTimesChart() {
        const activeTimes = state.learningStats.activeTimes;
        
        // Clear existing bars
        timeBarChart.innerHTML = '';
        
        // Add bars for each time
        for (const [time, value] of Object.entries(activeTimes)) {
          const bar = document.createElement('div');
          bar.className = 'time-bar';
          bar.style.height = `${value}%`;
          bar.setAttribute('data-time', time);
          timeBarChart.appendChild(bar);
        }
      }
      
      // Initialize learning progress chart
      function initializeLearningProgressChart() {
        const canvas = document.getElementById('learning-progress-chart');
        const ctx = canvas.getContext('2d');
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Set canvas dimensions
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = 300;
        
        // Get progress history data
        const progressData = state.learningStats.progressHistory;
        
        // Draw chart background
        ctx.fillStyle = 'rgba(77, 132, 255, 0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw axes
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(50, 30);
        ctx.lineTo(50, canvas.height - 30);
        ctx.lineTo(canvas.width - 30, canvas.height - 30);
        ctx.stroke();
        
        // Draw labels
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        
        // Y-axis labels
        for (let i = 0; i <= 100; i += 20) {
          const y = canvas.height - 30 - (i / 100) * (canvas.height - 60);
          ctx.fillText(i.toString(), 45, y);
        }
        
        // X-axis labels
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        
        const xStep = (canvas.width - 80) / (progressData.length - 1);
        progressData.forEach((point, index) => {
          const x = 50 + index * xStep;
          const date = new Date(point.date);
          const label = `${date.getMonth() + 1}/${date.getDate()}`;
          ctx.fillText(label, x, canvas.height - 25);
        });
        
        // Draw progress line
        ctx.strokeStyle = 'rgba(77, 132, 255, 1)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        progressData.forEach((point, index) => {
          const x = 50 + index * xStep;
          const y = canvas.height - 30 - (point.value / 100) * (canvas.height - 60);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        
        ctx.stroke();
        
        // Draw points
        ctx.fillStyle = 'rgba(77, 132, 255, 1)';
        
        progressData.forEach((point, index) => {
          const x = 50 + index * xStep;
          const y = canvas.height - 30 - (point.value / 100) * (canvas.height - 60);
          
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.fill();
        });
      }
      
      // Update learning stats
      function updateLearningStats(activity) {
        const stats = state.learningStats;
        
        // Update based on activity type
        switch (activity) {
          case 'messaging':
            // Increase JavaScript skill
            stats.skills.javascript = Math.min(stats.skills.javascript + 1, 100);
            break;
            
          case 'error':
            // Increase debugging skill
            stats.skills.debugging = Math.min(stats.skills.debugging + 2, 100);
            // Update error resolution stats
            stats.errorResolution.totalFixed++;
            break;
            
          case 'challenge':
            // Increase problem solving skill
            stats.skills.problemSolving = Math.min(stats.skills.problemSolving + 3, 100);
            break;
        }
        
        // Update streak
        const today = new Date().toISOString().split('T')[0];
        if (!stats.streak.activeDays.includes(today)) {
          stats.streak.activeDays.push(today);
          
          // Check if streak continues
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayString = yesterday.toISOString().split('T')[0];
          
          if (stats.streak.activeDays.includes(yesterdayString)) {
            stats.streak.currentStreak++;
          } else {
            stats.streak.currentStreak = 1;
          }
        }
        
        // Update active times
        const hour = new Date().getHours();
        let timeKey;
        
        if (hour < 3) timeKey = '12AM';
        else if (hour < 6) timeKey = '3AM';
        else if (hour < 9) timeKey = '6AM';
        else if (hour < 12) timeKey = '9AM';
        else if (hour < 15) timeKey = '12PM';
        else if (hour < 18) timeKey = '3PM';
        else if (hour < 21) timeKey = '6PM';
        else timeKey = '9PM';
        
        stats.activeTimes[timeKey] = (stats.activeTimes[timeKey] || 0) + 5;
        
        // Save updated stats
        state.learningStats = stats;
        vscode.setState(state);
        
        // Update UI
        initializeLearningAnalytics();
        
        // Send to extension
        vscode.postMessage({
          command: 'updateLearningStats',
          stats: stats
        });
      }
      
      // Theme selection
      themeOptions.forEach(option => {
        option.addEventListener('click', () => {
          const themeName = option.getAttribute('data-theme');
          applyTheme(themeName);
          
          // Close dropdown
          const dropdownContent = document.querySelector('.dropdown-content');
          if (dropdownContent) {
            dropdownContent.classList.remove('show');
          }
        });
      });
      
      // Theme dropdown toggle
      themeDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdownContent = document.querySelector('.dropdown-content');
        dropdownContent.classList.toggle('show');
      });
      
      // Close dropdown when clicking outside
      window.addEventListener('click', (e) => {
        if (!e.target.matches('.dropdown-button') && 
            !e.target.matches('.codicon-chevron-down') && 
            !e.target.closest('.dropdown-content')) {
          const dropdowns = document.querySelectorAll('.dropdown-content');
          dropdowns.forEach(dropdown => {
            if (dropdown.classList.contains('show')) {
              dropdown.classList.remove('show');
            }
          });
        }
      });
      
      // Event Listeners
      sendButton.addEventListener('click', sendMessage);
      
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      explainErrorBtn.addEventListener('click', () => {
        vscode.postMessage({
          command: 'explainError'
        });
        
        // Update learning stats
        updateLearningStats('error');
      });
      
      setApiKeyBtn.addEventListener('click', () => {
        vscode.postMessage({
          command: 'setHuggingFaceApiToken'
        });
      });
      
      // Reset goals button
      resetGoalsBtn.addEventListener('click', () => {
        resetWeeklyGoals();
      });
      
      // Goal increment buttons
      goalIncrementBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const goalId = btn.getAttribute('data-goal-id');
          if (goalId) {
            updateGoalProgress(goalId, 1);
            
            // Update learning stats
            updateLearningStats('challenge');
          }
        });
      });
      
      // Time filter
      timeFilter.addEventListener('change', () => {
        displayActivities(state.activities, timeFilter.value);
      });
      
      // Tab switching
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tab = button.dataset.tab;
          
          // Update active tab
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Show corresponding content
          tabContents.forEach(content => content.classList.remove('active'));
          document.getElementById(`${tab}-tab`).classList.add('active');
          
          // Update state
          state.activeTab = tab;
          vscode.setState(state);
          
          // Notify extension if switching to learning journal
          if (tab === 'journal') {
            vscode.postMessage({
              command: 'openLearningJournal'
            });
            
            // Refresh learning analytics
            initializeLearningAnalytics();
          }
        });
      });
      
      // Toggle response mode
      toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
          const mode = button.dataset.mode;
          
          // Update active button
          toggleButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Update state
          state.responseMode = mode;
          vscode.setState(state);
          
          // Notify extension
          vscode.postMessage({
            command: 'toggleMode',
            mode: mode
          });
        });
      });
      
      // Socratic strictness toggle
      socraticButtons.forEach(button => {
        button.addEventListener('click', () => {
          const level = button.dataset.level;
          
          // Update active button
          socraticButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Update state
          state.socraticLevel = level;
          vscode.setState(state);
          
          // Notify extension
          vscode.postMessage({
            command: 'setSocraticLevel',
            level: level
          });
        });
      });
      
      // Handle messages from extension
      window.addEventListener('message', event => {
        const message = event.data;
        
        switch (message.command) {
          case 'receiveMessage':
            addMessageToUI(message.message.text, message.message.isUser);
            break;
            
          case 'updateDiagnostics':
            if (message.hasErrors) {
              errorExplainer.classList.remove('hidden');
            } else {
              errorExplainer.classList.add('hidden');
            }
            break;
            
          case 'explainError':
            // Add the error explanation as an AI message
            const errorText = `I noticed an error in your code: "${message.error.message}" at line ${message.error.line}, column ${message.error.column}. Let me help you understand what's happening...`;
            addMessageToUI(errorText, false);
            break;
            
          case 'showLearningJournal':
            // Switch to learning journal tab
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('[data-tab="journal"]').classList.add('active');
            document.getElementById('journal-tab').classList.add('active');
            
            // Refresh learning analytics
            initializeLearningAnalytics();
            break;
            
          case 'apiKeyStatus':
            if (message.status === 'missing') {
              apiKeyWarning.classList.remove('hidden');
            } else {
              apiKeyWarning.classList.add('hidden');
            }
            break;

          case 'initExperience':
            // Initialize experience from extension's stored values
            state.exp = message.exp;
            state.level = message.level;
            state.expToNextLevel = message.expToNextLevel;
            
            // Update UI
            const progressPercent = (state.exp / state.expToNextLevel) * 100;
            
            document.getElementById('exp-value').textContent = `${state.exp} XP`;
            document.getElementById('exp-fill').style.width = `${progressPercent}%`;
            document.getElementById('current-level').textContent = state.level;
            document.getElementById('level-progress').textContent = `${state.exp}/${state.expToNextLevel}`;
            
            // Save to webview state
            vscode.setState(state);
            break;
            
          case 'updateWeeklyGoals':
            // Update weekly goals UI
            updateWeeklyGoalsUI(message.goals);
            break;
            
          case 'updateActivities':
            // Update activities UI
            state.activities = message.activities;
            vscode.setState(state);
            displayActivities(state.activities, timeFilter.value);
            break;

          case 'updateLearningStats':
            // Update learning stats
            state.learningStats = message.stats;
            vscode.setState(state);
            initializeLearningAnalytics();
            break;

          case 'showNotification':
            // Show notification banner
            notificationMessage.textContent = message.text;
            notificationBanner.classList.remove('hidden');
            
            // Hide notification after 5 seconds
            setTimeout(() => {
              notificationBanner.classList.add('hidden');
            }, 5000);
            break;
        }
      });

      // Initialize exp bar from state
      if (state.exp !== undefined) {
        // Calculate XP needed for current level if not set
        if (!state.expToNextLevel) {
          state.expToNextLevel = Math.floor(100 * Math.pow(1.5, state.level - 1));
        }
        
        const progressPercent = (state.exp / state.expToNextLevel) * 100;
        
        document.getElementById('exp-value').textContent = `${state.exp} XP`;
        document.getElementById('exp-fill').style.width = `${progressPercent}%`;
        document.getElementById('current-level').textContent = state.level || 1;
        document.getElementById('level-progress').textContent = `${state.exp}/${state.expToNextLevel}`;
      }
      
      // Initialize activities UI
      if (state.activities) {
        displayActivities(state.activities, timeFilter.value);
      }

      // Show/hide code snippets panel
      showSnippetsBtn.addEventListener('click', () => {
        codeSnippetsPanel.classList.remove('hidden');
      });
      
      closeSnippetsBtn.addEventListener('click', () => {
        codeSnippetsPanel.classList.add('hidden');
      });
      
      // Show/hide keyboard shortcuts modal
      showKeyboardShortcutsBtn.addEventListener('click', () => {
        keyboardShortcutsModal.classList.remove('hidden');
      });
      
      closeShortcutsModalBtn.addEventListener('click', () => {
        keyboardShortcutsModal.classList.add('hidden');
      });
      
      closeNotificationBtn.addEventListener('click', () => {
        notificationBanner.classList.add('hidden');
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey) {
          switch (e.key) {
            case 'Enter':
              sendMessage();
              break;
            case 'l':
              // Clear conversation logic here (if implemented)
              break;
            case 's':
              // Save conversation logic here (if implemented)
              break;
            case 'b':
              codeSnippetsPanel.classList.toggle('hidden');
              break;
            case '1':
              // Switch to Chat tab
              tabButtons.forEach(btn => btn.classList.remove('active'));
              tabContents.forEach(content => content.classList.remove('active'));
              document.querySelector('[data-tab="chat"]').classList.add('active');
              document.getElementById('chat-tab').classList.add('active');
              break;
            case '2':
              // Switch to Learning Journal tab
              tabButtons.forEach(btn => btn.classList.remove('active'));
              tabContents.forEach(content => content.classList.remove('active'));
              document.querySelector('[data-tab="journal"]').classList.add('active');
              document.getElementById('journal-tab').classList.add('active');
              initializeLearningAnalytics();
              break;
            case '/':
              keyboardShortcutsModal.classList.remove('hidden');
              break;
          }
        }
      });
      
      // Handle window resize for chart
      window.addEventListener('resize', () => {
        initializeLearningProgressChart();
      });
      
      // Initialize learning analytics on load
      initializeLearningAnalytics();
    })();
  </script>
</body>
</html>
